Test GISNav
____________________________________________________

This section describes how you can run and test your :ref:`local GISNav installation
<Install locally>`. The instructions here are only useful if you are doing
development work on GISNav.

Prerequisites
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

* Install the development dependencies as described :ref:`here <Install Python dependencies>`

Launch tests
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

`Launch tests <https://index.ros.org/p/launch_testing/>`_ are provided for smoke testing launch files for common
launch configurations in the :py:mod:`test.launch` package:

.. code-block:: bash
    :caption: Run ROS launch tests

    cd ~/colcon_ws
    launch_test src/gisnav/gisnav/test/launch/test_px4_launch.py

SITL tests
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
SITL tests are under the ``gisnav/test/sitl`` folder. Use the below ``make``
command to run the SITL test:

.. code-block:: bash

    cd ~/colcon_ws/src/gisnav/gisnav
    make test-sitl

.. note::
    The script assumes you have already built the services defined in the
    ``docker-compose.yaml`` file.

Flight Log Analysis
****************************************************
The flight log generated by the SITL test can be analyzed with the Jupyter notebooks in ``test/ulog_analysis`` folder.
You must first start ``jupyter-notebook``:

.. code-block:: bash

    cd ~/px4_ros_com_ros2/src/gisnav/gisnav/test/sitl/ulog_analysis
    jupyter-notebook

The notebook documents the analysis and displays the results. Download the example ULog file from Google Drive `here
<https://drive.google.com/drive/folders/1SmcOV11IJG4qL7Of77mpNICeiLP_9fH7?usp=sharing>`_.

Generate code coverage reports
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
To generate and inspect code coverage you can use ``coverage.py``. See the
`official instructions <https://coverage.readthedocs.io/en/6.4.1/source.html>`_ on how to configure what source files
to measure:

.. code-block:: bash
    :caption: Run and inspect code coverage report for ROS launch tests for PX4 (Fast DDS) launch configuration

    cd ~/colcon_ws
    python3 -m coverage run --branch --include */site-packages/gisnav/* src/gisnav/gisnav/test/test_px4_launch.py
    python3 -m coverage report
